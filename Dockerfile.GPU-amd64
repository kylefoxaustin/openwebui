FROM python:3.11-slim

WORKDIR /app

# Install minimal dependencies
RUN apt-get update && apt-get install -y curl supervisor && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Copy pre-built files
COPY ./build /app/build
COPY ./backend /app/backend
COPY ./CHANGELOG.md /app/
COPY ./package.json /app/

# Install only what's needed
RUN pip install --no-cache-dir -r /app/backend/requirements.txt && \
    pip install --no-cache-dir uvicorn

# Create data directories
RUN mkdir -p /app/backend/data && chmod -R 777 /app/backend/data && \
    mkdir -p /root/.ollama && chmod -R 777 /root/.ollama

# Set up a simpler supervisor configuration
RUN echo '[supervisord]\n\
nodaemon=true\n\
\n\
[program:ollama]\n\
command=/usr/local/bin/ollama serve\n\
\n\
[program:openwebui]\n\
command=bash -c "cd /app/backend && python -m uvicorn open_webui.main:app --host 0.0.0.0 --port 8080"\n\
' > /etc/supervisor/conf.d/supervisord.conf

# Environment variables
ENV PORT=8080 \
    HOST=0.0.0.0 \
    OLLAMA_BASE_URL="http://localhost:11434"

# Expose ports
EXPOSE 8080 11434

# Create volumes
VOLUME /root/.ollama
VOLUME /app/backend/data

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
